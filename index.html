<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CryptoPanel HOLDER PRO v3.2 - Risk Integrated</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: { 950: '#05070a', 900: '#0b0e14', 800: '#151a23', 700: '#232a3b', 600: '#374151' },
                        brand: { 500: '#3b82f6', 600: '#2563eb' },
                        score: { high: '#10b981', mid: '#f59e0b', low: '#ef4444' },
                        holder: {
                            accumulation: '#22c55e',
                            holding: '#3b82f6', 
                            profit_taking: '#ef4444',
                            dca_zone: '#8b5cf6'
                        },
                        zone: {
                            agressive: '#059669',
                            moderate: '#10b981',
                            fair: '#3b82f6',
                            partial: '#f59e0b',
                            full: '#ef4444'
                        }
                    },
                    animation: { 
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pulse-accumulation': 'pulse 2s ease-in-out infinite'
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Setup */
        body { background-color: #05070a; color: #e5e7eb; overflow-x: hidden; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #0b0e14; }
        ::-webkit-scrollbar-thumb { background: #232a3b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
        
        /* Glassmorphism */
        .glass { background: rgba(11, 14, 20, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* Table Optimization */
        .table-fixed-header thead { position: sticky; top: 0; z-index: 20; background-color: #0b0e14; box-shadow: 0 1px 0 rgba(255,255,255,0.1); }
        .table-row-hover:hover td { background-color: rgba(59, 130, 246, 0.08); }
        .compact-table th, .compact-table td { white-space: nowrap; padding: 0.5rem 0.75rem !important; } 
        
        /* Tooltip Overlay Avan√ßado */
        #metric-tooltip-overlay { 
            position: fixed; bottom: 0; left: 0; right: 0;
            height: auto; max-height: 80vh;
            background-color: #0b0e14;
            border-top: 2px solid #3b82f6;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.9);
            z-index: 9999;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex; flex-direction: column; gap: 1rem;
            padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
        }
        @media(min-width: 1024px) { 
            #metric-tooltip-overlay { 
                flex-direction: row; max-height: 60vh; width: 500px; 
                left: auto; right: 20px; bottom: 20px;
                border: 1px solid #3b82f6; border-radius: 12px; 
            } 
        }

        .tooltip-hidden { transform: translateY(110%); opacity: 0; pointer-events: none; }
        .tooltip-visible { transform: translateY(0); opacity: 1; pointer-events: auto; }

        /* Estilos Internos do Tooltip */
        .tt-section { margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .tt-section:last-child { border-bottom: none; }
        .tt-header { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; display: flex; items-center; gap: 6px; }
        .tt-def { color: #60a5fa; } /* Defini√ß√£o (Blue) */
        .tt-calc { color: #a78bfa; } /* C√°lculo (Purple) */
        .tt-ref { color: #34d399; } /* Refer√™ncia (Green) */
        .tt-strat { color: #facc15; } /* Estrat√©gia (Yellow) */
        .tt-trap { color: #f87171; } /* Armadilha (Red) */
        .tt-text { font-size: 0.85rem; line-height: 1.4; color: #d1d5db; }

        /* Animations */
        .card-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modal */
        .modal-overlay { background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        
        /* Indicators */
        .historical-band { position: absolute; width: 100%; opacity: 0.1; z-index: 1; }
        
        /* Mobile Specific Utilities */
        .mobile-tab-active { border-bottom: 2px solid #22c55e; color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .mobile-tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
        
        .var-box {
            @apply flex flex-col items-center justify-center p-2 rounded bg-dark-800/50 backdrop-blur-sm border border-gray-800 min-h-[50px];
        }

        /* Holder Phases Colors */
        .holder-phase-accumulation { border-left: 4px solid #22c55e; background: linear-gradient(90deg, rgba(34, 197, 94, 0.05) 0%, transparent 100%); }
        .holder-phase-holding { border-left: 4px solid #3b82f6; background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%); }
        .holder-phase-profit { border-left: 4px solid #ef4444; background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%); }

        /* Range Sliders inside cards */
        .zone-indicator { height: 4px; border-radius: 2px; margin: 2px 0; flex: 1; }
        .zone-0-20 { background: #059669; }
        .zone-20-40 { background: #10b981; }
        .zone-40-60 { background: #3b82f6; }
        .zone-60-80 { background: #f59e0b; }
        .zone-80-100 { background: #ef4444; }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Menu Transition */
        #mobile-controls {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0; opacity: 0; overflow: hidden;
        }
        #mobile-controls.open { max-height: 300px; opacity: 1; }
        
        /* Loading States */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col font-sans selection:bg-brand-500 selection:text-white">

    <header class="glass sticky top-0 z-50 border-b border-gray-800 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-gradient-to-br from-holder-accumulation to-holder-holding rounded-lg flex items-center justify-center shadow-lg shadow-green-500/20" data-tip="sys_logo">
                    <i class="fa-solid fa-chart-line text-white text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-white tracking-tight leading-none" data-tip="sys_title">CP<span class="text-holder-accumulation">HOLDER</span> <span class="text-[10px] text-gray-500 border border-gray-700 rounded px-1 align-middle ml-1">v3.2 RISK</span></h1>
                    <div class="flex items-center gap-2 text-[10px] text-gray-400 font-mono">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                        <span id="last-update" data-tip="sys_sync">Syncing...</span>
                    </div>
                </div>
            </div>

            <button id="mobile-menu-btn" class="sm:hidden w-10 h-10 flex items-center justify-center rounded-lg bg-dark-800 border border-gray-700 text-gray-300 hover:text-white hover:bg-dark-700 transition-colors">
                <i class="fa-solid fa-bars"></i>
            </button>

            <div class="hidden sm:flex items-center gap-3">
                <div class="relative group">
                    <input id="searchTokenDesktop" type="text" placeholder="BUSCAR ATIVO..." class="bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-xs text-white focus:border-holder-accumulation outline-none w-48 uppercase font-mono">
                    <i class="fa-solid fa-search absolute right-3 top-2.5 text-gray-500 text-xs"></i>
                </div>
                
                <div class="h-8 w-[1px] bg-gray-800 mx-1"></div>

                <div class="flex flex-col items-end mr-2" data-tip="sys_auto">
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">Auto</span>
                    <span id="countdown-desktop" class="text-xs font-mono font-bold text-holder-accumulation">720s</span>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="App.Export.openModal()" class="w-9 h-9 bg-dark-800 hover:text-green-400 border border-gray-700 rounded-lg transition-all flex items-center justify-center" title="Exportar" data-tip="btn_export"><i class="fa-solid fa-file-excel"></i></button>
                    <button id="refreshDataDesktop" class="w-9 h-9 bg-holder-accumulation hover:bg-green-500 rounded-lg text-white shadow-lg flex items-center justify-center transition-all" title="Atualizar" data-tip="btn_refresh"><i class="fa-solid fa-rotate"></i></button>
                    <button onclick="App.Settings.openModal()" class="w-9 h-9 bg-dark-800 hover:text-yellow-400 border border-gray-700 rounded-lg transition-all flex items-center justify-center" title="Configura√ß√µes" data-tip="btn_config"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>
        </div>

        <div id="mobile-controls" class="border-t border-gray-800 bg-dark-900 px-4">
            <div class="py-4 space-y-4">
                <div class="relative">
                    <input id="searchTokenMobile" type="text" placeholder="Buscar ativo (Ex: BTC)..." class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-3 text-sm text-white focus:border-holder-accumulation outline-none uppercase font-mono">
                    <i class="fa-solid fa-search absolute right-4 top-3.5 text-gray-500"></i>
                </div>
                
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-2 px-3 py-2 bg-dark-800 rounded-lg border border-gray-700 flex-1 justify-center">
                        <span class="text-[10px] text-gray-400 uppercase">Refresh:</span>
                        <span id="countdown-mobile" class="text-xs font-mono font-bold text-holder-accumulation">720s</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="App.Export.openModal()" class="p-3 bg-dark-800 border border-gray-700 rounded-lg text-gray-300"><i class="fa-solid fa-file-excel"></i></button>
                        <button id="refreshDataMobile" class="p-3 bg-holder-accumulation rounded-lg text-white shadow-lg"><i class="fa-solid fa-rotate"></i></button>
                        <button onclick="App.Settings.openModal()" class="p-3 bg-dark-800 border border-gray-700 rounded-lg text-gray-300"><i class="fa-solid fa-gear"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-dark-900 border-b border-gray-800 py-3 shadow-inner">
        <div class="max-w-[1800px] mx-auto px-4 flex flex-col sm:flex-row gap-3 overflow-x-auto no-scrollbar items-start sm:items-center">
            <span class="font-bold text-gray-500 uppercase tracking-widest text-[10px] shrink-0 flex items-center cursor-help" data-tip="log_band">
                <i class="fa-solid fa-info-circle mr-1"></i> Regress√£o Log (Fases):
            </span>
            <div class="flex gap-2 shrink-0 text-xs overflow-x-auto pb-1 w-full sm:w-auto">
                <span class="px-2 py-1 bg-dark-800 border border-green-500/30 rounded whitespace-nowrap text-[10px]"><span class="w-2 h-2 inline-block rounded-full bg-green-500 mr-1"></span>0-20: Fundo (Compra)</span>
                <span class="px-2 py-1 bg-dark-800 border border-blue-500/30 rounded whitespace-nowrap text-[10px]"><span class="w-2 h-2 inline-block rounded-full bg-blue-500 mr-1"></span>40-60: Meio (Hold)</span>
                <span class="px-2 py-1 bg-dark-800 border border-red-500/30 rounded whitespace-nowrap text-[10px]"><span class="w-2 h-2 inline-block rounded-full bg-red-500 mr-1"></span>80-100: Topo (Venda)</span>
            </div>
        </div>
    </div>

    <main class="flex-1 max-w-[1800px] mx-auto px-3 sm:px-4 py-4 sm:py-6 w-full gap-6 flex flex-col">
        
        <section class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-xl">
            <div class="bg-dark-800/80 p-4 border-b border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-white font-bold text-sm flex items-center gap-2" data-tip="table_header"><i class="fa-solid fa-star text-yellow-500"></i> Painel de Risco & Oportunidades (Quant v3.1)</h3>
                <span class="text-[10px] text-gray-500 bg-dark-950 px-2 py-1 rounded border border-gray-800">Risk-Adjusted</span>
            </div>
            
            <div class="overflow-x-auto scrollbar-thin max-h-[400px]">
                <table class="w-full text-left text-xs compact-table">
                    <thead class="text-gray-400 uppercase font-bold tracking-wider text-[10px] bg-dark-900 sticky top-0 z-10">
                        <tr>
                            <th class="p-3 text-center w-10">#</th>
                            <th class="p-3 sticky left-0 bg-dark-900 z-20 shadow-lg border-r border-gray-800">Ativo</th>
                            <th class="p-3 text-center" data-tip="score_total">Score 3.1</th>
                            <th class="p-3 text-center" data-tip="log_zone">Zona Log</th>
                            <th class="p-3 text-right">Pre√ßo</th>
                            <th class="p-3 text-center" data-tip="asymmetry">Assimetria</th>
                            <th class="p-3 text-center" data-tip="prob_emp">Prob. Real</th>
                            <th class="p-3 text-center" data-tip="risk_class">Risco</th>
                            <th class="p-3 text-center min-w-[100px]">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="opportunities-body" class="divide-y divide-gray-800 text-gray-300">
                        <tr><td colspan="9" class="p-8 text-center text-gray-600 italic">Carregando dados quantitativos...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <div class="sm:hidden flex rounded-lg bg-dark-800 p-1 border border-gray-700">
            <button onclick="App.UI.switchTab('agressive')" id="tab-btn-agressive" class="flex-1 py-2 text-[10px] font-bold uppercase rounded mobile-tab-active" data-tip="tab_acc">Acumula√ß√£o</button>
            <button onclick="App.UI.switchTab('fair')" id="tab-btn-fair" class="flex-1 py-2 text-[10px] font-bold uppercase rounded mobile-tab-inactive" data-tip="tab_hold">Justo</button>
            <button onclick="App.UI.switchTab('full')" id="tab-btn-full" class="flex-1 py-2 text-[10px] font-bold uppercase rounded mobile-tab-inactive" data-tip="tab_dist">Realiza√ß√£o</button>
        </div>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 relative">
            <div id="zone-card-agressive" class="glass rounded-xl overflow-hidden border border-zone-agressive flex flex-col shadow-lg transition-all duration-300">
                <div class="bg-dark-800/90 p-3 border-b border-zone-agressive flex justify-between items-center">
                    <h3 class="text-zone-agressive font-bold text-xs uppercase tracking-wide gap-2 flex items-center" data-tip="zone_buy"><i class="fa-solid fa-bolt"></i> Acumula√ß√£o (Log Bottom)</h3>
                    <i class="fa-solid fa-arrow-down text-zone-agressive text-xs animate-bounce"></i>
                </div>
                <div class="overflow-y-auto flex-1 max-h-[300px] min-h-[200px]">
                    <table class="w-full text-left text-[11px] compact-table">
                         <tbody id="list-agressive" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="zone-card-fair" class="glass rounded-xl overflow-hidden border border-zone-fair flex flex-col shadow-lg hidden md:flex transition-all duration-300">
                <div class="bg-dark-800/90 p-3 border-b border-zone-fair flex justify-between items-center">
                    <h3 class="text-zone-fair font-bold text-xs uppercase tracking-wide gap-2 flex items-center" data-tip="zone_hold"><i class="fa-solid fa-scale-balanced"></i> Pre√ßo Justo (Log Mid)</h3>
                </div>
                <div class="overflow-y-auto flex-1 max-h-[300px] min-h-[200px]">
                     <table class="w-full text-left text-[11px] compact-table">
                         <tbody id="list-fair" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="zone-card-full" class="glass rounded-xl overflow-hidden border border-zone-full flex flex-col shadow-lg hidden md:flex transitionall duration-300">
                <div class="bg-dark-800/90 p-3 border-b border-zone-full flex justify-between items-center">
                    <h3 class="text-zone-full font-bold text-xs uppercase tracking-wide gap-2 flex items-center" data-tip="zone_sell"><i class="fa-solid fa-money-bill-wave"></i> Realiza√ß√£o (Log Top)</h3>
                    <i class="fa-solid fa-arrow-up text-zone-full text-xs animate-bounce"></i>
                </div>
                <div class="overflow-y-auto flex-1 max-h-[300px] min-h-[200px]">
                     <table class="w-full text-left text-[11px] compact-table">
                         <tbody id="list-full" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="alerts-panel" class="glass rounded-xl overflow-hidden border border-holder-dca_zone flex flex-col shadow-lg">
            <div class="bg-purple-900/10 p-3 border-b border-holder-dca_zone/30 flex justify-between items-center">
                <h3 class="text-holder-dca_zone font-bold text-sm flex items-center gap-2" data-tip="panel_alerts"><i class="fa-solid fa-bell"></i> Monitoramento de Alertas</h3>
                <button onclick="App.Alerts.openModal()" class="px-3 py-1.5 bg-holder-dca_zone/20 hover:bg-holder-dca_zone text-holder-dca_zone hover:text-white border border-holder-dca_zone rounded-lg text-xs font-bold transition-all" data-tip="btn_add_alert">+ CRIAR</button>
            </div>
            <div class="p-3"><div id="alertsContent" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar"></div></div>
        </section>

        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between mt-2">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <div class="relative group w-full sm:w-72">
                    <input type="text" id="add-input" placeholder="Adicionar TICKER (Ex: LINK)..." class="w-full bg-dark-900 border border-gray-700 rounded-lg pl-4 pr-10 py-3 text-sm focus:border-holder-accumulation outline-none uppercase shadow-inner transition-all font-mono">
                    <button onclick="App.Token.add()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-dark-800 text-holder-accumulation hover:text-white hover:bg-green-600 p-1.5 rounded-md transition-all" data-tip="btn_add_token"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>
        
        <div id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 pb-20"></div>
    </main>

    <div id="metric-tooltip-overlay" class="tooltip-hidden backdrop-blur-md"></div>

    <div id="alertsModal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md max-h-[90dvh] flex flex-col mx-auto animate-fade-in-up">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center shrink-0 rounded-t-xl">
                <h3 class="text-white font-bold">Novo Alerta</h3>
                <button onclick="App.Alerts.closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700 text-gray-400"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 overflow-y-auto flex-1">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1.5 uppercase">Ativo</label>
                    <select id="alert-symbol" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-holder-accumulation outline-none appearance-none"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1.5 uppercase">Estrat√©gia</label>
                    <select id="alert-type" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-holder-accumulation outline-none">
                        <option value="buy">üìâ Comprar (Abaixo de)</option>
                        <option value="sell">üìà Vender (Acima de)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1.5 uppercase">Pre√ßo Alvo ($)</label>
                    <input type="number" id="alert-price" step="any" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-holder-accumulation outline-none font-mono text-lg" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1.5 uppercase">Nota</label>
                    <textarea id="alert-notes" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-4 py-2 text-white outline-none resize-none text-sm" rows="2" placeholder="Ex: Entrar pesado..."></textarea>
                </div>
            </div>
            <div class="p-4 border-t border-gray-800 bg-dark-800/50 rounded-b-xl flex gap-3">
                <button onclick="App.Alerts.closeModal()" class="flex-1 py-3 bg-dark-700 text-white rounded-lg font-bold text-sm">Cancelar</button>
                <button onclick="App.Alerts.createAlert()" class="flex-1 py-3 bg-holder-accumulation hover:bg-green-500 text-white rounded-lg font-bold text-sm shadow-lg shadow-green-900/20">Salvar Alerta</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-lg max-h-[90dvh] flex flex-col">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-white font-bold">Configura√ß√µes</h3>
                <button onclick="App.Settings.closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-5 space-y-6 overflow-y-auto flex-1">
                <div>
                    <div class="text-xs font-bold text-gray-500 uppercase mb-2">Gerenciar Ativos Atuais</div>
                    <div id="settings-tokens-list" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 bg-dark-950 rounded border border-gray-800"></div>
                </div>
                
                <div>
                    <div class="text-xs font-bold text-gray-500 uppercase mb-2">Adicionar em Lote</div>
                    <textarea id="batch-tokens" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-xs font-mono" rows="3" placeholder="BTC&#10;ETH&#10;SOL"></textarea>
                </div>
            </div>
            <div class="p-4 border-t border-gray-800 flex gap-3">
                <button onclick="App.Token.removeSelected()" class="px-4 py-2 bg-red-900/30 text-red-400 border border-red-900 rounded-lg text-xs font-bold">Excluir Selecionados</button>
                <div class="flex-1"></div>
                <button onclick="App.Token.addBatch()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold">Adicionar</button>
            </div>
        </div>
    </div>
    
    <div id="export-modal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-sm">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Relat√≥rios</h3>
                <button onclick="App.Export.closeModal()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-3">
                <button onclick="App.Export.gen('xlsx')" class="w-full bg-dark-800 border border-gray-600 hover:border-green-500 hover:text-green-400 text-gray-200 font-bold py-3 rounded-lg flex items-center justify-center gap-3 transition-all">
                    <i class="fa-solid fa-table"></i> Dados Completos (.XLSX)
                </button>
            </div>
        </div>
    </div>

    <template id="card-template">
        <div class="card glass rounded-xl overflow-hidden hover:border-gray-500 transition-all duration-300 card-enter flex flex-col group shadow-lg relative" data-symbol="">
            <button class="btn-remove absolute top-2 right-2 z-30 text-gray-500 hover:text-red-500 bg-dark-900/90 rounded-full w-8 h-8 flex items-center justify-center backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity" title="Remover"><i class="fa-solid fa-times"></i></button>
            
            <div class="p-4 cursor-pointer relative z-10 bg-gradient-to-b from-dark-800/40 to-transparent" onclick="App.UI.toggleCard(this)">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-3">
                        <div class="score-badge w-11 h-11 rounded-xl flex items-center justify-center text-lg font-bold text-black border border-white/20 shadow-lg cursor-help" data-tip="score_total">--</div>
                        <div>
                            <h3 class="font-bold text-white text-xl symbol-ticker leading-none tracking-tight">BTC</h3>
                            <div class="text-[10px] text-gray-400 symbol-name truncate max-w-[120px]">Bitcoin</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-mono font-bold text-white price-display" data-tip="price_curr">$0.00</div>
                        <div class="text-[10px] font-mono mt-0.5"><span class="val-24h" data-tip="chg_24h">--</span> <span class="text-gray-600">|</span> <span class="market-cap-value text-gray-400" data-tip="mcap">--</span></div>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-3">
                    <span class="phase-badge text-[9px] font-bold uppercase px-2 py-1 rounded bg-dark-800 text-gray-400 flex-1 text-center border border-gray-800" data-tip="cycle_phase">--</span>
                    <span class="zone-badge text-[9px] font-bold uppercase px-2 py-1 rounded bg-dark-800 text-gray-400 flex-1 text-center border border-gray-800" data-tip="log_zone">--</span>
                </div>

                <div class="grid grid-cols-4 gap-2 mb-3">
                    <div class="var-box" data-tip="chg_1h"><div class="text-[8px] text-gray-500 uppercase font-bold">1H</div><div class="text-[10px] font-bold font-mono val-1h">--%</div></div>
                    <div class="var-box bg-dark-700/30 border-gray-700" data-tip="chg_24h"><div class="text-[8px] text-gray-400 uppercase font-bold">24H</div><div class="text-[10px] font-bold font-mono val-24h-box">--%</div></div>
                    <div class="var-box" data-tip="chg_7d"><div class="text-[8px] text-gray-500 uppercase font-bold">7D</div><div class="text-[10px] font-bold font-mono val-7d">--%</div></div>
                    <div class="var-box" data-tip="chg_30d"><div class="text-[8px] text-gray-500 uppercase font-bold">30D</div><div class="text-[10px] font-bold font-mono val-30d">--%</div></div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="space-y-2">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold border-b border-gray-800 pb-1">Fundamentos</h5>
                        <div class="flex justify-between items-center" data-tip="fdv_ratio"><span class="text-[10px] text-gray-500">MC/FDV:</span><span class="val-mc-fdv font-mono text-[10px] font-bold">--</span></div>
                        <div class="flex justify-between items-center" data-tip="vol_anual"><span class="text-[10px] text-gray-500">Vol. Anual:</span><span class="val-annual-vol font-mono text-[10px]">--%</span></div>
                        <div class="flex justify-between items-center" data-tip="rsi_w"><span class="text-[10px] text-gray-500">RSI(W):</span><span class="metric-rsi-weekly font-mono text-[10px] font-bold text-white">--</span></div>
                    </div>
                    <div class="space-y-2">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold border-b border-gray-800 pb-1">An√°lise v3.1</h5>
                        <div class="flex justify-between items-center" data-tip="asymmetry"><span class="text-[10px] text-gray-500">Assimetria:</span><span class="real-asymmetry-value font-bold text-[10px]">--x</span></div>
                        <div class="flex justify-between items-center" data-tip="prob_emp"><span class="text-[10px] text-gray-500">Probab.:</span><span class="statistical-probability-value font-bold text-[10px]">--%</span></div>
                        <div class="flex justify-between items-center" data-tip="risk_class"><span class="text-[10px] text-gray-500">Risco:</span><span class="val-risk-class text-[10px] font-bold">--</span></div>
                    </div>
                </div>

                <div class="relative h-1.5 w-full bg-dark-900 rounded-full overflow-hidden flex cursor-help" data-tip="log_band">
                    <div class="zone-indicator zone-0-20"></div>
                    <div class="zone-indicator zone-20-40"></div>
                    <div class="zone-indicator zone-40-60"></div>
                    <div class="zone-indicator zone-60-80"></div>
                    <div class="zone-indicator zone-80-100"></div>
                    <div class="absolute top-0 bottom-0 w-0.5 bg-white shadow-[0_0_8px_rgba(255,255,255,0.8)] z-10 historical-indicator transition-all duration-1000" style="left: 50%;"></div>
                </div>
                <div class="text-[9px] text-center text-gray-500 mt-1">Regress√£o Logar√≠tmica: <span class="historical-position text-gray-300 font-bold">--</span>%</div>
            </div>

            <div class="card-body hidden border-t border-gray-800 bg-dark-900 relative z-20 p-0">
                <div class="h-56 w-full bg-black chart-container relative">
                    <div class="absolute top-2 left-2 z-10 text-[9px] text-gray-500 bg-black/50 px-1 rounded">Weekly + SMA20/50/200 + Vol</div>
                </div>
                
                <div class="p-4 space-y-4">
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="text-[9px] text-gray-500 uppercase font-bold" data-tip="card_alerts">Alertas Ativos</h5>
                            <button class="text-[9px] bg-holder-dca_zone/20 text-holder-dca_zone px-2 py-0.5 rounded border border-holder-dca_zone/30" onclick="App.Alerts.openForCard(this)">+ NOVO</button>
                        </div>
                        <div class="alert-list space-y-1 empty:text-[10px] empty:text-gray-600 empty:text-center empty:py-1 text-[10px]"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                         <div class="space-y-2">
                            <h5 class="text-[9px] text-gray-500 uppercase font-bold border-b border-gray-800 pb-1">Valuation</h5>
                            <div class="flex justify-between text-[10px]"><span class="text-gray-500" data-tip="fdv">FDV:</span><span class="val-fdv font-mono text-gray-300">--</span></div>
                            <div class="flex justify-between text-[10px]"><span class="text-gray-500" data-tip="ath_dist">Desc. ATH:</span><span class="val-ath-discount font-mono">--%</span></div>
                            <div class="flex justify-between text-[10px]"><span class="text-gray-500" data-tip="liq_ratio">Liquidez:</span><span class="val-liq font-mono">--</span></div>
                        </div>
                        <div class="space-y-2">
                            <h5 class="text-[9px] text-gray-500 uppercase font-bold border-b border-gray-800 pb-1">T√©cnico</h5>
                            <div class="flex justify-between text-[10px]"><span class="text-gray-500" data-tip="sma_status">SMA 200W:</span><span class="analysis-sma font-bold">--</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // ===== CONFIGURA√á√ÉO SUPABASE =====
// SUBSTITUA COM SUAS CREDENCIAIS!
const SUPABASE_URL = 'https://alvfhnbeecoagyfvjhjc.supabase.co'; // COLE SUA URL AQUI
const SUPABASE_KEY = 'sb_publishable_etmScGm97-IN35DCtlm-6g_xraY_k2w'; // COLE SUA KEY AQUI

// Inicializar Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Constants & Config
const API = { BINANCE: "https://api.binance.com/api/v3", COINGECKO: "https://api.coingecko.com/api/v3" };
const QUANT_CONFIG = { rsiPeriod: 14, volatilityWindow: 52, regressionLookback: 156 };

// --- MATH & STATISTICS ENGINE ---
const Quant = {
    mean: (arr) => arr.reduce((a, b) => a + b, 0) / arr.length,
    stdDev: (arr) => { 
        if (arr.length < 2) return 0;
        const m = Quant.mean(arr); 
        return Math.sqrt(arr.reduce((sq, n) => sq + Math.pow(n - m, 2), 0) / (arr.length - 1)); 
    },
    sma: (arr, period) => {
        if (arr.length < period) return arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0; 
        return arr.slice(-period).reduce((a, b) => a + b, 0) / period;
    },
    rsi: (closes, period = 14) => {
        if (closes.length < period + 1) return 50;
        let gains = 0, losses = 0;
        for (let i = 1; i <= period; i++) { 
            let diff = closes[i] - closes[i - 1]; 
            if (diff >= 0) gains += diff; 
            else losses -= diff; 
        }
        let avgGain = gains / period; 
        let avgLoss = losses / period;
        for (let i = period + 1; i < closes.length; i++) {
            let diff = closes[i] - closes[i - 1];
            if (diff >= 0) { 
                avgGain = (avgGain * (period - 1) + diff) / period; 
                avgLoss = (avgLoss * (period - 1)) / period; 
            } 
            else { 
                avgGain = (avgGain * (period - 1)) / period; 
                avgLoss = (avgLoss * (period - 1) - diff) / period; 
            }
        }
        if (avgLoss === 0) return 100;
        return 100 - (100 / (1 + (avgGain / avgLoss)));
    },
    logRegression: (prices) => {
        const n = prices.length;
        if (n < 2) return { fair: prices[0] || 0, top: prices[0] || 0, bottom: prices[0] || 0, stdev: 0, regressionPrice: prices[0] || 0, params: {a: 0, b: 0} };
        
        let sumY = 0, sumLnX = 0, sumYLnX = 0, sumLnX2 = 0;
        for (let i = 0; i < n; i++) {
            let x = i + 1; 
            let lnY = Math.log(prices[i]); 
            let lnX = Math.log(x);
            sumY += lnY; 
            sumLnX += lnX; 
            sumYLnX += lnY * lnX; 
            sumLnX2 += lnX * lnX;
        }
        const b = (n * sumYLnX - sumLnX * sumY) / (n * sumLnX2 - sumLnX * sumLnX);
        const a = (sumY - b * sumLnX) / n;
        let residuals = [];
        for(let i = 0; i < n; i++) {
            residuals.push(Math.log(prices[i]) - (a + b * Math.log(i + 1)));
        }
        const stdev = Quant.stdDev(residuals) || 0.1;
        const currentX = n; 
        const fairLnY = a + b * Math.log(currentX);
        return { 
            fair: Math.exp(fairLnY), 
            top: Math.exp(fairLnY + 2 * stdev), 
            bottom: Math.exp(fairLnY - 2 * stdev), 
            stdev: stdev, 
            regressionPrice: Math.exp(fairLnY),
            params: {a, b}
        };
    },
    volatility: (closes) => {
        if (closes.length < 2) return 0;
        let logReturns = [];
        for(let i = 1; i < closes.length; i++) {
            if (closes[i-1] > 0) {
                logReturns.push(Math.log(closes[i] / closes[i-1]));
            }
        }
        if (logReturns.length === 0) return 0;
        const window = Math.min(logReturns.length, QUANT_CONFIG.volatilityWindow);
        const std = Quant.stdDev(logReturns.slice(-window));
        return std * Math.sqrt(52); 
    },
    empiricalProb: (closes, currentZScore, stdev, params) => {
        if (!closes || closes.length < 10) return 50;
        let wins = 0;
        let total = 0;
        const lookback = Math.min(closes.length - 5, 200); 
        for(let i = closes.length - lookback; i < closes.length - 4; i++) {
            const timeX = i + 1;
            const predLog = params.a + params.b * Math.log(timeX);
            const actualLog = Math.log(closes[i]);
            const z = (actualLog - predLog) / stdev;
            if (Math.abs(z - currentZScore) < 0.5) {
                total++;
                if (closes[i+4] > closes[i]) wins++;
            }
        }
        if (total < 5) return 50; 
        return (wins / total) * 100;
    }
};

const App = {
    State: {
        tokens: [],
        alerts: [],
        data: {}, 
        activeTab: 'agressive'
    },

    // --- LIBRARY (Tooltips) --- (MANTENHA IGUAL)
    Library: {
        // Sistema
        'sys_logo': { t:"HOLDER PRO", d:"Algoritmo de an√°lise quantitativa de risco e ciclo.", r:"Vers√£o 3.2 Risk Integrated." },
        'sys_title': { t:"PAINEL DE CONTROLE", d:"Vis√£o geral do mercado com foco em longo prazo.", s:"Use para monitorar sa√∫de da carteira." },
        'sys_sync': { t:"STATUS DE SINCRONIZA√á√ÉO", d:"Indica atividade da API em tempo real.", c:"Atualiza a cada 720s." },
        'sys_auto': { t:"AUTO REFRESH", d:"Contador regressivo para nova an√°lise.", t:"N√£o feche a aba durante o sync." },
        'btn_export': { t:"EXPORTAR DADOS", d:"Gera planilha Excel (.xlsx) com todos os indicadores calculados.", s:"√ötil para backup ou an√°lise offline." },
        'btn_refresh': { t:"ATUALIZAR AGORA", d:"For√ßa o rec√°lculo de todos os ativos.", s:"Use ap√≥s adicionar novos tokens." },
        'btn_config': { t:"CONFIGURA√á√ïES", d:"Gerencie sua lista de ativos e prefer√™ncias.", s:"Adicione tokens em lote." },
        'btn_add_token': { t:"ADICIONAR TOKEN", d:"Insere um novo par USDT para monitoramento.", t:"Deve existir na Binance." },
        'btn_add_alert': { t:"CRIAR ALERTA", d:"Define um pre√ßo alvo para notifica√ß√£o.", s:"Use n√≠veis de suporte/resist√™ncia." },

        // Tabela Principal
        'table_header': { t:"PAINEL DE RISCO", d:"Ranking de ativos ordenado pelo Score Holder 3.1.", s:"Foque nos ativos com Score > 70 e Risco A ou B." },
        'score_total': { t:"SCORE HOLDER 3.1", d:"Nota final de qualidade (0-100).", c:"Valuation(40%) + Ciclo(30%) + Liquidez(20%) + T√©cnico(10%).", r:">70: Excelente, <40: Ruim.", s:"Priorize ativos com score alto para entradas." },
        'log_zone': { t:"ZONA LOGAR√çTMICA", d:"Posi√ß√£o do pre√ßo dentro do canal de regress√£o de longo prazo.", c:"((LogPre√ßo - LogFundo) / (LogTopo - LogFundo)) * 100.", r:"0-20%: Fundo, 80-100%: Topo.", s:"Compre em zonas baixas (<30%), Venda em zonas altas (>70%)." },
        'asymmetry': { t:"ASSIMETRIA REAL", d:"Rela√ß√£o Potencial de Lucro / Risco Real.", c:"Upside at√© Topo Log / Downside at√© Suporte ou Volatilidade.", r:">4x: Excelente assimetria.", s:"Busque assimetrias altas para proteger capital." },
        'prob_emp': { t:"PROBABILIDADE EMP√çRICA", d:"Chance hist√≥rica de lucro baseada em padr√µes passados id√™nticos.", c:"Backtest de situa√ß√µes similares de Desvio Padr√£o.", r:">60%: Alta probabilidade.", t:"Passado n√£o garante futuro." },
        'risk_class': { t:"CLASSE DE RISCO", d:"Categoriza√ß√£o de seguran√ßa estrutural.", c:"Baseado em FDV, Liquidez e Drawdown do ATH.", r:"A: Muito Seguro -> F: Muito Arriscado.", t:"Evite Classe F para Hold." },
        
        // Tabs & Zones
        'tab_acc': { t:"FASE DE ACUMULA√á√ÉO", d:"Ativos baratos historicamente (Fundo do Canal Log).", s:"Melhor momento para DCA." },
        'tab_hold': { t:"FASE DE HOLD", d:"Ativos em pre√ßo justo ou tend√™ncia intermedi√°ria.", s:"Manter posi√ß√£o, evitar compras pesadas." },
        'tab_dist': { t:"FASE DE DISTRIBUI√á√ÉO", d:"Ativos caros historicamente (Topo do Canal Log).", s:"Realizar lucros parciais." },
        'zone_buy': { t:"ZONA DE COMPRA", d:"Ativos abaixo de 30% do canal logar√≠tmico.", s:"Foco total em acumula√ß√£o." },
        'zone_hold': { t:"ZONA NEUTRA", d:"Ativos entre 40% e 60% do canal.", s:"Aguardar defini√ß√£o." },
        'zone_sell': { t:"ZONA DE VENDA", d:"Ativos acima de 70% do canal.", s:"Prepare sa√≠das escalonadas." },
        
        // Painel Alertas
        'panel_alerts': { t:"MONITORAMENTO", d:"Lista de pre√ßos-alvo vigentes.", s:"Mantenha limpo, remova alertas j√° atingidos." },

        // Card Metrics
        'price_curr': { t:"PRE√áO ATUAL", d:"√öltimo pre√ßo negociado na Binance (USDT)." },
        'chg_1h': { t:"VARIA√á√ÉO 1H", d:"Mudan√ßa percentual na √∫ltima hora.", s:"Mede momentum imediato." },
        'chg_24h': { t:"VARIA√á√ÉO 24H", d:"Mudan√ßa percentual no √∫ltimo dia.", s:"Principal m√©trica de volatilidade di√°ria." },
        'chg_7d': { t:"VARIA√á√ÉO 7D", d:"Mudan√ßa percentual na semana.", s:"Identifica tend√™ncia de curto prazo." },
        'chg_30d': { t:"VARIA√á√ÉO 30D", d:"Mudan√ßa percentual no m√™s.", s:"Identifica tend√™ncia de m√©dio prazo." },
        'mcap': { t:"MARKET CAP", d:"Valor de mercado do supply circulante.", c:"Pre√ßo * Circulating Supply.", r:"Microcap < 100M, Largecap > 10B.", t:"Menor Mcap = Maior Volatilidade." },
        
        'fdv_ratio': { t:"RAZ√ÉO MC/FDV", d:"Quanto do supply total j√° est√° no mercado.", c:"Market Cap / Fully Diluted Valuation.", r:">0.8: Bom (pouca infla√ß√£o), <0.2: Ruim (muita infla√ß√£o).", t:"Cuidado com desbloqueios de tokens." },
        'vol_anual': { t:"VOLATILIDADE ANUAL", d:"Expectativa estat√≠stica de varia√ß√£o de pre√ßo.", c:"Desvio Padr√£o dos retornos * Raiz(52).", r:">100%: Alt√≠ssima volatilidade.", s:"Reduza tamanho da posi√ß√£o em alta volatilidade." },
        'rsi_w': { t:"RSI SEMANAL", d:"√çndice de For√ßa Relativa (14 per√≠odos).", r:"<30: Sobrevendido (Oportunidade), >70: Sobrecomprado (Risco).", s:"Conflu√™ncia ideal: RSI baixo + Zona Log baixa." },
        
        'log_band': { t:"BARRA DE REGRESS√ÉO", d:"Visualiza√ß√£o da posi√ß√£o do pre√ßo no canal.", s:"Marcador √† esquerda = Barato. Marcador √† direita = Caro." },
        'cycle_phase': { t:"FASE DO CICLO", d:"Interpreta√ß√£o textual da zona logar√≠tmica.", r:"Acumular, Manter, Realizar." },
        
        'card_alerts': { t:"ALERTAS DESTE ATIVO", d:"Alvos espec√≠ficos configurados para este token." },
        'fdv': { t:"FULLY DILUTED VALUATION", d:"Valor de mercado se todos os tokens existissem hoje.", t:"Se FDV >> Mcap, risco de dilui√ß√£o." },
        'ath_dist': { t:"DESCONTO DO ATH", d:"Queda percentual desde o topo hist√≥rico.", s:"Em Bull Market, descontos >50% em bons projetos s√£o oportunidades." },
        'liq_ratio': { t:"RAZ√ÉO DE LIQUIDEZ", d:"Volume negociado em rela√ß√£o ao tamanho do ativo.", c:"Vol24h / Mcap.", r:">0.05: L√≠quido, <0.01: Il√≠quido.", t:"Baixa liquidez = dificuldade de sair da posi√ß√£o." },
        'sma_status': { t:"SMA 200 SEMANAS", d:"M√©dia de longo prazo. O suporte mais forte do mercado.", s:"Pre√ßo acima = Bullish. Pre√ßo abaixo = Bearish/Acumula√ß√£o." },
    },

    // --- CORE FUNCTIONALITY COM SUPABASE ---
    Core: {
        init: async () => {
            console.log('üöÄ Inicializando CryptoPanel com Supabase...');
            
            // Carregar tokens do Supabase
            await App.Core.loadTokens();
            
            // Carregar alertas do Supabase
            await App.Core.loadAlerts();
            
            // Configurar UI
            App.UI.setupMobileMenu(); 
            App.UI.tooltips(); 
            App.UI.grid();
            
            // Configurar escuta em tempo real
            App.Core.setupRealtime();
            
            // Bot√µes de refresh
            document.getElementById('refreshDataDesktop').addEventListener('click', () => App.Core.refreshData());
            document.getElementById('refreshDataMobile').addEventListener('click', () => App.Core.refreshData());
            
            // Carregar dados iniciais
            await App.Core.refreshData();
            
            // Configurar auto-refresh
            let countdown = 720;
            setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                    countdown = 720;
                    App.Core.refreshData();
                }
                document.getElementById('countdown-desktop').innerText = countdown + 's';
                document.getElementById('countdown-mobile').innerText = countdown + 's';
            }, 1000);
            
            // Atualizar UI
            document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
            console.log('‚úÖ CryptoPanel inicializado com sucesso!');
        },

        // Carregar tokens do Supabase
        loadTokens: async () => {
            try {
                const { data, error } = await supabase
                    .from('tokens')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                App.State.tokens = data.map(t => ({
                    symbol: t.symbol,
                    name: t.name || t.symbol.replace('USDT', ''),
                    coinId: t.coin_id || t.symbol.replace('USDT', '').toLowerCase()
                }));
                
                console.log(`üìä ${App.State.tokens.length} tokens carregados do Supabase`);
            } catch (error) {
                console.error('‚ùå Erro ao carregar tokens:', error);
                // Fallback b√°sico
                App.State.tokens = [
                    {symbol: 'BTCUSDT', name: 'Bitcoin', coinId: 'bitcoin'},
                    {symbol: 'ETHUSDT', name: 'Ethereum', coinId: 'ethereum'},
                    {symbol: 'SOLUSDT', name: 'Solana', coinId: 'solana'}
                ];
            }
        },

        // Carregar alertas do Supabase
                loadAlerts: async () => {
            try {
                console.log('üîÑ Carregando alertas do Supabase...');
                
                const { data, error } = await supabase
                    .from('alerts')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                App.State.alerts = data.map(a => ({
                    id: a.id,
                    symbol: a.symbol,
                    type: a.type,
                    targetPrice: parseFloat(a.target_price),
                    notes: a.notes || '',
                    triggered: a.triggered || false
                }));
                
                console.log(`‚úÖ ${App.State.alerts.length} alertas carregados do Supabase`);
                
                // Verificar alertas acionados
                await App.Alerts.checkAll();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar alertas:', error);
                App.State.alerts = [];
            }
        },

        // Configurar escuta em tempo real
        setupRealtime: () => {
            // Escutar mudan√ßas em tokens
            supabase
                .channel('tokens-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'tokens' },
                    async () => {
                        console.log('üîÑ Mudan√ßa detectada em tokens, recarregando...');
                        await App.Core.loadTokens();
                        App.UI.grid();
                        App.Core.refreshData();
                    }
                )
                .subscribe();

            // Escutar mudan√ßas em alertas
            supabase
                .channel('alerts-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'alerts' },
                    async () => {
                        console.log('üîÑ Mudan√ßa detectada em alertas, recarregando...');
                        await App.Core.loadAlerts();
                        App.Alerts.renderPanel();
                        App.UI.updateAllCards();
                    }
                )
                .subscribe();
        },

        refreshData: async () => {
            console.log('üîÑ Atualizando dados de mercado...');
            document.getElementById('last-update').innerText = "Analyzing...";
            
            for (let token of App.State.tokens) {
                try {
                    const [klines1h, klinesDaily, klinesWeekly, fundamentals] = await Promise.all([
                        App.Core.fetchKlines(token.symbol, '1h', 24),
                        App.Core.fetchKlines(token.symbol, '1d', 35),
                        App.Core.fetchKlines(token.symbol, '1w', 250),
                        App.Core.fetchFundamentals(token.coinId)
                    ]);

                    if(klinesWeekly && klinesWeekly.length > 50) {
                        const quant = App.Analysis.run(token.symbol, klinesWeekly, klinesDaily, klines1h, fundamentals);
                        App.State.data[token.symbol] = { 
                            klines: { w: klinesWeekly, d: klinesDaily, h: klines1h }, 
                            fundamentals, 
                            analysis: quant 
                        };
                    }
                } catch (error) {
                    console.error(`‚ùå Erro ao processar ${token.symbol}:`, error);
                }
            }
            
            App.Alerts.checkAll();
            App.UI.updateAllCards(); 
            App.Opportunities.render();
            document.getElementById('last-update').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            console.log('‚úÖ Dados atualizados');
        },

        fetchKlines: async (symbol, interval, limit) => {
            try {
                const response = await fetch(`${API.BINANCE}/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                return data.map(k => ({ 
                    time: k[0], 
                    open: parseFloat(k[1]), 
                    high: parseFloat(k[2]), 
                    low: parseFloat(k[3]), 
                    close: parseFloat(k[4]), 
                    volume: parseFloat(k[5]) 
                }));
            } catch (error) {
                console.error(`‚ùå Erro ao buscar klines para ${symbol}:`, error);
                return [];
            }
        },

        fetchFundamentals: async (coinId) => {
            try {
                const response = await fetch(`${API.COINGECKO}/coins/${coinId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                const md = data.market_data;
                return {
                    price: md.current_price?.usd || 0,
                    mcap: md.market_cap?.usd || 0,
                    fdv: md.fully_diluted_valuation?.usd || md.market_cap?.usd || 0,
                    vol24: md.total_volume?.usd || 0,
                    ath: md.ath?.usd || 0,
                    ath_change: md.ath_change_percentage?.usd || 0,
                    circ_supply: md.circulating_supply || 0,
                    total_supply: md.total_supply || md.circulating_supply || 0
                };
            } catch (error) {
                console.error(`‚ùå Erro ao buscar fundamentos para ${coinId}:`, error);
                return null;
            }
        }
    },

    // --- ANALYSIS ENGINE (MANTENHA IGUAL) ---
    Analysis: {
        run: (symbol, w, d, h, fund) => {
            const closesW = w.map(k => k.close);
            const currentPrice = closesW[closesW.length - 1] || 0;
            const rsiW = Quant.rsi(closesW, 14);
            const volAnn = Quant.volatility(closesW); 
            const sma200W = Quant.sma(closesW, 200);

            const reg = Quant.logRegression(closesW);
            const logPrice = Math.log(Math.max(currentPrice, 0.0001));
            const logBottom = Math.log(Math.max(reg.bottom, 0.0001));
            const logTop = Math.log(Math.max(reg.top, 0.0001));
            const bandRange = logTop - logBottom;
            const positionInBand = bandRange > 0 ? Math.max(0, Math.min(100, ((logPrice - logBottom) / bandRange) * 100)) : 50;

            const upside = Math.max(0, reg.top - currentPrice);
            const distLog = Math.max(0, currentPrice - reg.bottom);
            const distSMA = sma200W ? Math.max(0, currentPrice - sma200W) : 0;
            const volDrop = currentPrice * (volAnn / 2); 
            const downsideReal = Math.max(distLog, distSMA, volDrop);
            const asymmetry = downsideReal === 0 ? 10 : (upside / downsideReal);

            const zScore = (Math.log(Math.max(currentPrice, 0.0001)) - Math.log(Math.max(reg.regressionPrice, 0.0001))) / reg.stdev;
            const probProfit = Quant.empiricalProb(closesW, zScore, reg.stdev, reg.params);

            const chg1h = h && h.length > 1 ? ((h[h.length-1].close - h[0].open)/h[0].open)*100 : 0;
            const chg24h = d && d.length > 1 ? ((d[d.length-1].close - d[d.length-2].close)/d[d.length-2].close)*100 : 0; 
            const chg7d = d && d.length > 7 ? ((d[d.length-1].close - d[d.length-8].close)/d[d.length-8].close)*100 : 0;
            const chg30d = d && d.length > 30 ? ((d[d.length-1].close - d[d.length-31].close)/d[d.length-31].close)*100 : 0;

            const inflation = fund ? ((fund.total_supply - fund.circ_supply) / Math.max(fund.circ_supply, 1)) * 100 : 0;
            let rawLiq = fund && fund.mcap > 0 ? (fund.vol24 / fund.mcap) : 0;
            const liqRatio = Math.min(rawLiq, 0.3);

            let riskScore = 0;
            const fdvRatio = fund && fund.mcap > 0 ? fund.fdv / fund.mcap : 1;
            if(fdvRatio > 5) riskScore += 3;
            else if(fdvRatio > 2) riskScore += 1;
            if(rawLiq < 0.01) riskScore += 3;
            else if(rawLiq < 0.03) riskScore += 1;
            if(fund && Math.abs(fund.ath_change) > 90) riskScore += 3;
            else if(fund && Math.abs(fund.ath_change) > 75) riskScore += 1;

            const riskPenalty = Math.min(20, riskScore * 2.5);
            const riskClass = riskScore >= 7 ? 'F' : riskScore >= 5 ? 'D' : riskScore >= 3 ? 'C' : riskScore >= 1 ? 'B' : 'A';

            let score = 0;
            let sc_val_ath = Math.min(100, Math.max(0, Math.abs(fund?.ath_change || 0) * 1.2)); 
            let sc_val_inf = Math.max(0, 100 - (inflation * 2));
            score += 0.40 * (0.6*sc_val_ath + 0.4*sc_val_inf);

            let sc_cyc_band = 100 - positionInBand; 
            let sc_cyc_sma = sma200W ? ((currentPrice < sma200W) ? 100 : Math.max(0, 100 - ((currentPrice/sma200W - 1)*100))) : 50;
            score += 0.30 * (0.7*sc_cyc_band + 0.3*sc_cyc_sma);

            let sc_fund_liq = Math.min(100, liqRatio * 333); 
            score += 0.20 * sc_fund_liq;

            let sc_tec_rsi = Math.max(0, Math.min(100, (70 - rsiW) * 2.5));
            score += 0.10 * sc_tec_rsi;

            score = Math.max(0, Math.min(100, score - riskPenalty));

            return {
                price: currentPrice, 
                rsiW, 
                volAnn, 
                sma200W,
                reg, 
                positionInBand, 
                asymmetry, 
                probProfit,
                chg: { h1: chg1h, h24: chg24h, d7: chg7d, d30: chg30d },
                fund: { inflation, liqRatio, ath_change: fund?.ath_change, fdv: fund?.fdv },
                risk: { class: riskClass, penalty: riskPenalty },
                score: Math.round(score)
            };
        }
    },

    // --- UI HANDLERS (MANTENHA IGUAL) ---
    UI: {
        setupMobileMenu: () => {
            const btn = document.getElementById('mobile-menu-btn');
            const menu = document.getElementById('mobile-controls');
            btn.addEventListener('click', () => {
                menu.classList.toggle('open');
                const icon = btn.querySelector('i');
                icon.className = menu.classList.contains('open') ? 'fa-solid fa-times' : 'fa-solid fa-bars';
            });
        },
        switchTab: (tabName) => {
            App.State.activeTab = tabName;
            ['agressive', 'fair', 'full'].forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                const card = document.getElementById(`zone-card-${t}`);
                if (btn && card) {
                    btn.className = `flex-1 py-2 text-[10px] font-bold uppercase rounded transition-all ${t === tabName ? 'mobile-tab-active' : 'mobile-tab-inactive'}`;
                    if (window.innerWidth < 768) {
                        card.style.display = (t === tabName) ? 'flex' : 'none';
                    } else {
                        card.style.display = 'flex';
                    }
                }
            });
        },
        scrollToCard: (symbol) => {
            const card = document.querySelector(`.card[data-symbol="${symbol}"]`);
            if(card) {
                card.scrollIntoView({behavior:'smooth', block:'center'});
                const cardBody = card.querySelector('.card-body');
                if(cardBody && cardBody.classList.contains('hidden')) {
                    App.UI.toggleCard(card.querySelector('.p-4'));
                }
            }
        },
        tooltips: () => {
            const ov = document.getElementById('metric-tooltip-overlay');
            document.body.addEventListener('click', (e) => { 
                let t = e.target.closest('[data-tip]'); 
                if(t){ 
                    let k = t.dataset.tip;
                    let d = App.Library[k];
                    if(d) {
                        let html = `<div class="flex-1">
                            <div class="tt-section"><div class="tt-header tt-def"><i class="fa-solid fa-book"></i> Defini√ß√£o</div><div class="tt-text text-white font-bold">${d.t}</div><div class="tt-text mt-1">${d.d}</div></div>`;
                        if(d.c) html += `<div class="tt-section"><div class="tt-header tt-calc"><i class="fa-solid fa-calculator"></i> L√≥gica</div><div class="tt-text font-mono text-xs">${d.c}</div></div>`;
                        if(d.r) html += `<div class="tt-section"><div class="tt-header tt-ref"><i class="fa-solid fa-ruler"></i> Refer√™ncia</div><div class="tt-text">${d.r}</div></div>`;
                        if(d.s) html += `<div class="tt-section"><div class="tt-header tt-strat"><i class="fa-solid fa-chess"></i> Estrat√©gia</div><div class="tt-text">${d.s}</div></div>`;
                        if(d.t) html += `<div class="tt-section"><div class="tt-header tt-trap"><i class="fa-solid fa-triangle-exclamation"></i> Aten√ß√£o</div><div class="tt-text">${d.t}</div></div>`;
                        html += `</div><button class="absolute top-2 right-2 p-2 text-gray-500 hover:text-white" onclick="this.parentElement.classList.add('tooltip-hidden');this.parentElement.classList.remove('tooltip-visible')"><i class="fa-solid fa-times"></i></button>`;
                        ov.innerHTML = html;
                        ov.classList.remove('tooltip-hidden'); 
                        ov.classList.add('tooltip-visible');
                    }
                    e.stopPropagation(); 
                } else if(!e.target.closest('#metric-tooltip-overlay')) {
                     ov.classList.remove('tooltip-visible'); 
                     ov.classList.add('tooltip-hidden'); 
                }
            });
        },
        grid: () => {
            let g = document.getElementById('cards-grid');
            if (!g) return;
            
            g.innerHTML='';
            App.State.tokens.forEach(token => {
                let tmpl = document.getElementById('card-template').content.cloneNode(true);
                let el = tmpl.querySelector('.card');
                el.dataset.symbol = token.symbol;
                el.querySelector('.symbol-ticker').innerText = token.symbol.replace('USDT','');
                el.querySelector('.symbol-name').innerText = token.name;
                el.querySelector('.btn-remove').onclick = (e)=>{e.stopPropagation(); App.Token.rem(token.symbol)};
                g.appendChild(el);
            });
            App.UI.switchTab('agressive');
            window.addEventListener('resize', () => App.UI.switchTab(App.State.activeTab));
        },
        updateAllCards: () => {
            App.State.tokens.forEach(token => {
                const data = App.State.data[token.symbol];
                if(data) {
                    App.UI.updateTokenCard(token.symbol, data);
                }
            });
        },
        updateTokenCard: (symbol, data) => {
            const card = document.querySelector(`.card[data-symbol="${symbol}"]`);
            if(!card) return;
            
            const a = data.analysis;
            const f = data.fundamentals;
            
            if (!a) return;
            
            // Header
            card.querySelector('.price-display').innerText = '$' + a.price.toFixed(a.price < 1 ? 4 : 2);
            if(f && f.mcap) {
                const mcapText = f.mcap > 1e9 ? `$${(f.mcap/1e9).toFixed(1)}B` : f.mcap > 1e6 ? `$${(f.mcap/1e6).toFixed(0)}M` : `$${f.mcap.toFixed(0)}`;
                card.querySelector('.market-cap-value').innerText = mcapText;
            }
            
            // Score & Phase
            const sb = card.querySelector('.score-badge');
            sb.innerText = a.score || '--';
            sb.className = `score-badge w-11 h-11 rounded-xl flex items-center justify-center text-lg font-bold text-black border border-white/20 shadow-lg cursor-help ${a.score>70?'bg-score-high':a.score<40?'bg-score-low':'bg-score-mid'}`;
            
            const pb = card.querySelector('.phase-badge');
            const phaseName = a.positionInBand < 20 ? 'ACUMULAR' : a.positionInBand > 80 ? 'REALIZAR' : 'MANTER';
            pb.innerText = phaseName;
            pb.className = `phase-badge text-[9px] font-bold uppercase px-2 py-1 rounded bg-dark-800 text-gray-400 flex-1 text-center border border-gray-800 ${phaseName==='ACUMULAR'?'text-green-400 bg-green-900/20':phaseName==='REALIZAR'?'text-red-400 bg-red-900/20':'text-blue-400'}`;
            
            card.querySelector('.zone-badge').innerText = (a.positionInBand || 0).toFixed(0) + '% Log';
            
            // Variations
            const color = v => v > 0 ? 'text-green-400' : 'text-red-400';
            card.querySelector('.val-1h').innerHTML = `<span class="${color(a.chg.h1)}">${(a.chg.h1 || 0).toFixed(2)}%</span>`;
            
            const chg24h = a.chg.h24 || 0;
            card.querySelector('.val-24h').innerHTML = `${chg24h>0?'+':''}${chg24h.toFixed(2)}%`;
            card.querySelector('.val-24h').className = `val-24h font-bold font-mono text-[10px] ${color(chg24h)}`;
            card.querySelector('.val-24h-box').innerHTML = `<span class="${color(chg24h)}">${chg24h.toFixed(2)}%</span>`;
            card.querySelector('.val-7d').innerHTML = `<span class="${color(a.chg.d7)}">${(a.chg.d7 || 0).toFixed(2)}%</span>`;
            card.querySelector('.val-30d').innerHTML = `<span class="${color(a.chg.d30)}">${(a.chg.d30 || 0).toFixed(2)}%</span>`;

            // Metrics
            const rsiEl = card.querySelector('.metric-rsi-weekly');
            rsiEl.innerText = (a.rsiW || 0).toFixed(0);
            rsiEl.className = `metric-rsi-weekly font-mono text-[10px] font-bold ${a.rsiW<30?'text-green-400':a.rsiW>70?'text-red-400':'text-white'}`;
            
            card.querySelector('.val-annual-vol').innerText = ((a.volAnn || 0) * 100).toFixed(0) + '%';
            
            if(f && f.fdv && f.mcap) {
                const ratio = f.mcap / f.fdv;
                const fdvEl = card.querySelector('.val-mc-fdv');
                fdvEl.innerText = ratio.toFixed(2);
                fdvEl.className = `val-mc-fdv font-mono text-[10px] font-bold ${ratio>0.8?'text-green-400':ratio<0.2?'text-red-400':'text-yellow-400'}`;
            }

            card.querySelector('.real-asymmetry-value').innerText = (a.asymmetry || 0).toFixed(1) + 'x';
            card.querySelector('.statistical-probability-value').innerText = (a.probProfit || 0).toFixed(0) + '%';
            
            const rcEl = card.querySelector('.val-risk-class');
            rcEl.innerText = `Classe ${a.risk.class || 'N/A'}`;
            rcEl.className = `val-risk-class text-[10px] font-bold ${a.risk.class==='A'?'text-green-500':a.risk.class==='F'?'text-red-500':'text-yellow-500'}`;

            // Log Bar
            const bar = card.querySelector('.historical-indicator');
            if (bar) {
                bar.style.left = `${a.positionInBand || 50}%`;
            }
            card.querySelector('.historical-position').innerText = (a.positionInBand || 0).toFixed(0);

            // Body details
            card.querySelector('.val-fdv').innerText = f && f.fdv ? (f.fdv > 1e9 ? `$${(f.fdv/1e9).toFixed(1)}B` : '-') : '-';
            card.querySelector('.val-ath-discount').innerText = f && f.ath_change ? f.ath_change.toFixed(1) + '%' : '-';
            card.querySelector('.val-liq').innerText = (a.fund.liqRatio || 0).toFixed(3);
            card.querySelector('.analysis-sma').innerText = a.sma200W ? '$' + a.sma200W.toFixed(2) : '-';

            App.Alerts.renderInCard(symbol, card.querySelector('.alert-list'));
            
            // Verificar se o card est√° expandido e renderizar o gr√°fico
            if (!card.querySelector('.card-body').classList.contains('hidden')) {
                App.UI.renderChart(card);
            }
            
            // Phase border color
            card.classList.remove('holder-phase-accumulation', 'holder-phase-holding', 'holder-phase-profit');
            if (a.positionInBand < 20) {
                card.classList.add('holder-phase-accumulation');
            } else if (a.positionInBand > 80) {
                card.classList.add('holder-phase-profit');
            } else {
                card.classList.add('holder-phase-holding');
            }
        },
        toggleCard: (el) => {
            let card = el.closest('.card');
            let b = card.querySelector('.card-body');
            if(b.classList.contains('hidden')) {
                document.querySelectorAll('.card-body').forEach(e => e.classList.add('hidden'));
                b.classList.remove('hidden');
                App.UI.renderChart(card);
            } else {
                b.classList.add('hidden');
            }
        },
        renderChart: (card) => {
            const sym = card.dataset.symbol;
            const d = App.State.data[sym];
            const container = card.querySelector('.chart-container');
            
            if(!d || !container || !d.klines || !d.klines.w || d.klines.w.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Sem dados de gr√°fico</div>';
                return;
            }
            
            // Limpar container
            container.innerHTML = '';
            
            try {
                const chart = LightweightCharts.createChart(container, {
                    layout: { 
                        background: { color: '#000000' }, 
                        textColor: '#6b7280', 
                        fontSize: 11 
                    },
                    grid: { 
                        vertLines: { color: '#1f2937' }, 
                        horzLines: { color: '#1f2937' } 
                    },
                    rightPriceScale: { 
                        borderVisible: false, 
                        scaleMargins: { top: 0.1, bottom: 0.1 } 
                    },
                    timeScale: { 
                        timeVisible: true, 
                        secondsVisible: false 
                    },
                    width: container.clientWidth, 
                    height: container.clientHeight
                });
                
                const candleSeries = chart.addCandlestickSeries({ 
                    upColor: '#10b981', 
                    downColor: '#ef4444', 
                    borderVisible: false, 
                    wickUpColor: '#10b981', 
                    wickDownColor: '#ef4444' 
                });
                
                const chartData = d.klines.w.map(k => ({ 
                    time: k.time/1000, 
                    open: k.open, 
                    high: k.high, 
                    low: k.low, 
                    close: k.close 
                }));
                candleSeries.setData(chartData);
                
                // Adicionar SMAs se houver dados suficientes
                if (d.klines.w.length >= 20) {
                    const sma20 = chart.addLineSeries({ color: '#f59e0b', lineWidth: 1 });
                    const sma20Data = [];
                    const closes = d.klines.w.map(k => k.close);
                    
                    for(let i = 19; i < closes.length; i++) {
                        const periodCloses = closes.slice(i-19, i+1);
                        const smaValue = periodCloses.reduce((sum, val) => sum + val, 0) / 20;
                        sma20Data.push({ 
                            time: d.klines.w[i].time/1000, 
                            value: smaValue 
                        });
                    }
                    sma20.setData(sma20Data);
                }
                
                chart.timeScale().fitContent();
            } catch (error) {
                console.error('Erro ao renderizar gr√°fico:', error);
                container.innerHTML = '<div class="flex items-center justify-center h-full text-red-500">Erro no gr√°fico</div>';
            }
        }
    },

    // --- OPPORTUNITIES & ALERTS ---
    Opportunities: {
        render: () => {
            const data = Object.keys(App.State.data)
                .map(k => ({s: k, ...App.State.data[k]}))
                .filter(d => d.analysis)
                .sort((a,b) => (b.analysis.score || 0) - (a.analysis.score || 0));
            
            const tbody = document.getElementById('opportunities-body');
            if(tbody) {
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-600 italic">Nenhum dado dispon√≠vel</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map((d, i) => {
                    const a = d.analysis;
                    const zoneName = a.positionInBand < 20 ? 'Fundo' : a.positionInBand > 80 ? 'Topo' : 'Meio';
                    return `
                        <tr class="table-row-hover border-b border-gray-800 cursor-pointer" onclick="App.UI.scrollToCard('${d.s}')">
                            <td class="p-3 text-center text-gray-500 font-bold">${i+1}</td>
                            <td class="p-3 sticky left-0 bg-dark-900 font-bold text-white border-r border-gray-800 shadow-md">${d.s.replace('USDT','')}</td>
                            <td class="p-3 text-center font-bold ${a.score>70?'text-green-400':a.score<40?'text-red-400':'text-blue-400'}">${a.score}</td>
                            <td class="p-3 text-center text-[10px] text-gray-400">${zoneName} (${a.positionInBand.toFixed(0)}%)</td>
                            <td class="p-3 text-right font-mono text-white">$${a.price.toFixed(2)}</td>
                            <td class="p-3 text-center font-mono ${a.asymmetry>3?'text-green-400':'text-yellow-400'}">${a.asymmetry.toFixed(1)}x</td>
                            <td class="p-3 text-center font-mono text-gray-400">${a.probProfit.toFixed(0)}%</td>
                            <td class="p-3 text-center font-bold text-xs ${a.risk.class==='A'?'text-green-500':a.risk.class==='F'?'text-red-500':'text-yellow-500'}">${a.risk.class}</td>
                            <td class="p-3 text-center"><button onclick="event.stopPropagation(); App.Alerts.openForSymbol('${d.s}')" class="text-holder-accumulation hover:text-white p-2 rounded bg-dark-800 border border-gray-700"><i class="fa-solid fa-bell"></i></button></td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Renderizar zonas
            const renderZone = (id, filterFn) => {
                const el = document.getElementById(id);
                if(!el) return;
                const filtered = data.filter(filterFn);
                if (filtered.length === 0) {
                    el.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-600 text-[10px]">Nenhum ativo</td></tr>';
                    return;
                }
                el.innerHTML = filtered.map(d => `
                    <tr class="border-b border-gray-800/50 hover:bg-white/5 cursor-pointer" onclick="App.UI.scrollToCard('${d.s}')">
                        <td class="p-2 font-bold text-white">${d.s.replace('USDT','')}</td>
                        <td class="p-2 text-right text-gray-400 text-[10px]">${d.analysis.positionInBand.toFixed(0)}%</td>
                        <td class="p-2 text-right font-mono text-xs ${d.analysis.score>70?'text-green-400':'text-blue-400'}">${d.analysis.score}</td>
                    </tr>
                `).join('');
            };
            
            renderZone('list-agressive', d => d.analysis.positionInBand <= 30);
            renderZone('list-fair', d => d.analysis.positionInBand > 30 && d.analysis.positionInBand <= 70);
            renderZone('list-full', d => d.analysis.positionInBand > 70);
        }
    },

        Alerts: {
        init: () => App.Alerts.renderPanel(),
        openModal: () => {
            const modal = document.getElementById('alertsModal');
            if (modal) modal.classList.remove('hidden');
            
            // Popular dropdown de s√≠mbolos
            const select = document.getElementById('alert-symbol');
            if (select) {
                select.innerHTML = '<option value="">Selecione um token</option>';
                App.State.tokens.forEach(token => {
                    const option = document.createElement('option');
                    option.value = token.symbol;
                    option.text = token.symbol.replace('USDT', '') + ` (${token.name})`;
                    select.appendChild(option);
                });
                
                // Se houver s√≠mbolo na URL, selecionar
                const urlParams = new URLSearchParams(window.location.search);
                const tokenFromUrl = urlParams.get('token');
                if (tokenFromUrl) {
                    select.value = tokenFromUrl + 'USDT';
                }
            }
            
            // Focar no campo de pre√ßo
            setTimeout(() => {
                document.getElementById('alert-price')?.focus();
            }, 100);
        },
        openForSymbol: (s) => {
            App.Alerts.openModal();
            const sel = document.getElementById('alert-symbol');
            if (sel) {
                // Verificar se o s√≠mbolo existe nas op√ß√µes
                const optionExists = Array.from(sel.options).some(opt => opt.value === s);
                if (optionExists) {
                    sel.value = s;
                } else {
                    // Adicionar dinamicamente se n√£o existir
                    const newOpt = document.createElement('option');
                    newOpt.value = s;
                    newOpt.text = s.replace('USDT', '');
                    sel.appendChild(newOpt);
                    sel.value = s;
                }
            }
        },
        closeModal: () => {
            const modal = document.getElementById('alertsModal');
            if (modal) modal.classList.add('hidden');
            
            // Limpar campos
            document.getElementById('alert-price').value = '';
            document.getElementById('alert-notes').value = '';
        },
        createAlert: async () => {
            const sym = document.getElementById('alert-symbol')?.value;
            const type = document.getElementById('alert-type')?.value;
            const price = parseFloat(document.getElementById('alert-price')?.value);
            const notes = document.getElementById('alert-notes')?.value;
            
            if(!sym || sym === '') {
                alert('Selecione um token.');
                return;
            }
            
            if(!price || isNaN(price) || price <= 0) {
                alert('Digite um pre√ßo alvo v√°lido (maior que 0).');
                return;
            }
            
            try {
                console.log('üîÑ Criando alerta no Supabase...', { sym, type, price, notes });
                
                // Inserir no Supabase
                const { data, error } = await supabase
                    .from('alerts')
                    .insert([
                        {
                            symbol: sym,
                            type: type,
                            target_price: price,
                            notes: notes || '',
                            triggered: false
                        }
                    ])
                    .select();
                
                if (error) {
                    console.error('‚ùå Erro Supabase:', error);
                    
                    // Tratar erro espec√≠fico
                    if (error.code === '23505') {
                        alert('J√° existe um alerta igual para este token.');
                    } else if (error.code === '23514') {
                        alert('Tipo de alerta inv√°lido. Use "buy" ou "sell".');
                    } else {
                        alert(`Erro: ${error.message}`);
                    }
                    return;
                }
                
                console.log('‚úÖ Alerta criado no Supabase:', data[0]);
                
                // Fechar modal e limpar
                App.Alerts.closeModal();
                
                // Feedback visual
                const alertBtn = document.querySelector(`[onclick*="App.Alerts.openForSymbol('${sym}')"]`);
                if (alertBtn) {
                    const originalColor = alertBtn.style.color;
                    alertBtn.style.color = '#22c55e';
                    setTimeout(() => {
                        alertBtn.style.color = originalColor;
                    }, 1000);
                }
                
                alert(`‚úÖ Alerta criado para ${sym.replace('USDT', '')} em $${price}`);
                
                // O realtime subscription vai atualizar automaticamente
                
            } catch (error) {
                console.error('‚ùå Erro completo ao criar alerta:', error);
                alert('Erro ao criar alerta. Verifique console (F12) e conex√£o.');
            }
        },
        openForCard: (btn) => {
            const card = btn.closest('.card');
            if (card) {
                App.Alerts.openForSymbol(card.dataset.symbol);
            }
        },
        remove: async (id) => { 
            if(!confirm('Remover este alerta?')) return;
            
            try {
                console.log('üîÑ Removendo alerta:', id);
                
                const { error } = await supabase
                    .from('alerts')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                console.log('üóëÔ∏è Alerta removido do Supabase:', id);
                
                // Feedback visual
                const alertDiv = document.querySelector(`button[onclick*="App.Alerts.remove(${id})"]`)?.parentElement;
                if (alertDiv) {
                    alertDiv.style.opacity = '0.5';
                    setTimeout(() => {
                        alertDiv.style.display = 'none';
                    }, 300);
                }
                
                // O realtime subscription vai atualizar automaticamente
                
            } catch (error) {
                console.error('‚ùå Erro ao remover alerta:', error);
                alert('Erro ao remover alerta.');
            }
        },
        checkAll: async () => {
            let triggeredAny = false;
            
            console.log('üîç Verificando alertas...');
            
            for (let a of App.State.alerts) {
                if(a.triggered) {
                    continue; // J√° foi acionado
                }
                
                const d = App.State.data[a.symbol];
                if(!d || !d.analysis) {
                    console.log(`‚ö†Ô∏è Dados insuficientes para ${a.symbol}`);
                    continue;
                }
                
                const p = d.analysis.price;
                console.log(`üìä ${a.symbol}: Pre√ßo atual $${p.toFixed(4)}, Alvo $${a.targetPrice}`);
                
                // Verificar condi√ß√£o
                const shouldTrigger = (a.type === 'buy' && p <= a.targetPrice) || 
                                     (a.type === 'sell' && p >= a.targetPrice);
                
                if(shouldTrigger) {
                    console.log(`üö® ALERTA DISPARADO: ${a.symbol} ${a.type.toUpperCase()} em $${a.targetPrice}`);
                    
                    try {
                        // Atualizar no Supabase
                        const { error } = await supabase
                            .from('alerts')
                            .update({ 
                                triggered: true,
                                notes: (a.notes || '') + ` [Disparado em ${new Date().toLocaleString()}]`
                            })
                            .eq('id', a.id);
                        
                        if (error) throw error;
                        
                        a.triggered = true;
                        triggeredAny = true;
                        
                        // Notifica√ß√£o visual
                        alert(`üîî ALERTA: ${a.symbol.replace('USDT', '')} atingiu $${a.targetPrice.toFixed(4)}`);
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar alerta:', error);
                    }
                }
            }
            
            if(triggeredAny) {
                console.log('‚úÖ Alertas atualizados no Supabase');
                // O realtime vai atualizar automaticamente
            }
        },
        renderPanel: () => {
            const div = document.getElementById('alertsContent');
            if(!div) return;
            
            if(App.State.alerts.length === 0) { 
                div.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fa-solid fa-bell-slash text-gray-500 text-2xl mb-2"></i>
                        <div class="text-xs text-gray-500">Nenhum alerta configurado</div>
                        <button onclick="App.Alerts.openModal()" class="mt-2 text-xs text-holder-accumulation hover:underline">
                            + Criar primeiro alerta
                        </button>
                    </div>
                `; 
                return; 
            }
            
            // Ordenar: n√£o acionados primeiro, depois por data
            const sortedAlerts = [...App.State.alerts].sort((a, b) => {
                if (a.triggered !== b.triggered) return a.triggered ? 1 : -1;
                return b.id - a.id; // Mais recentes primeiro
            });
            
            div.innerHTML = sortedAlerts.map(a => {
                const tokenData = App.State.data[a.symbol];
                const currentPrice = tokenData?.analysis?.price || 0;
                const priceDiff = ((currentPrice - a.targetPrice) / a.targetPrice) * 100;
                const isAbove = currentPrice > a.targetPrice;
                
                return `
                <div class="flex justify-between items-center p-3 rounded-lg border ${a.triggered?'border-green-500/50 bg-green-900/10':'border-gray-700 bg-dark-800'} mb-2 transition-all hover:border-gray-600">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <div class="font-bold text-sm text-white">${a.symbol.replace('USDT','')}</div>
                            <span class="text-xs px-2 py-0.5 rounded ${a.type==='buy'?'bg-green-900/50 text-green-400':'bg-red-900/50 text-red-400'}">${a.type.toUpperCase()}</span>
                            ${a.triggered ? '<span class="text-xs px-2 py-0.5 rounded bg-green-900 text-green-300">‚úì DISPARADO</span>' : ''}
                        </div>
                        
                        <div class="mt-1">
                            <div class="text-xs text-gray-400">Alvo: <span class="font-mono text-white">$${a.targetPrice.toFixed(4)}</span></div>
                            ${currentPrice > 0 ? `
                                <div class="text-xs text-gray-400">
                                    Atual: <span class="font-mono ${isAbove ? 'text-green-400' : 'text-red-400'}">$${currentPrice.toFixed(4)}</span>
                                    <span class="ml-2 ${isAbove ? 'text-green-400' : 'text-red-400'}">${isAbove ? '‚Üë' : '‚Üì'} ${Math.abs(priceDiff).toFixed(2)}%</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${a.notes ? `<div class="mt-1 text-[10px] text-gray-500">${a.notes}</div>` : ''}
                    </div>
                    
                    <button onclick="App.Alerts.remove(${a.id})" 
                            class="ml-2 p-2 text-gray-500 hover:text-red-500 hover:bg-red-900/20 rounded-lg transition-colors"
                            title="Remover alerta">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>
                `;
            }).join('');
        },
        renderInCard: (s, container) => {
            if (!container) return;
            
            const alerts = App.State.alerts.filter(a => a.symbol === s && !a.triggered);
            if(alerts.length === 0) { 
                container.innerHTML = '<div class="text-gray-600 italic text-center py-2 text-[10px]">Nenhum alerta ativo</div>'; 
                return; 
            }
            
            container.innerHTML = alerts.map(a => `
                <div class="flex justify-between items-center text-[10px] p-1.5 rounded border border-gray-800/50 mb-1 hover:bg-dark-800 transition-colors">
                    <div class="flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full ${a.type==='buy'?'bg-green-500':'bg-red-500'}"></span>
                        <span class="${a.type==='buy'?'text-green-400':'text-red-400'} font-bold">${a.type.toUpperCase()}</span>
                    </div>
                    <span class="font-mono text-gray-300">$${a.targetPrice.toFixed(4)}</span>
                    <button onclick="App.Alerts.remove(${a.id})" 
                            class="text-gray-500 hover:text-red-500 text-xs"
                            title="Remover">
                        √ó
                    </button>
                </div>
            `).join('');
        }
    },

    // --- TOKEN MANAGEMENT COM SUPABASE ---
    Token: {
        add: async () => {
            const inp = document.getElementById('add-input');
            let s = inp?.value.trim().toUpperCase();
            if(!s) return;
            if(!s.endsWith('USDT')) s += 'USDT';
            
            // Verificar se j√° existe
            if(App.State.tokens.find(t=>t.symbol===s)) {
                alert('Token j√° existe.');
                return;
            }
            
            try {
                // Verificar na Binance
                const r = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${s}`);
                if(r.status !== 200) {
                    alert('Token n√£o encontrado na Binance.');
                    return;
                }
                
                const n = s.replace('USDT','');
                
                // Inserir no Supabase
                const { data, error } = await supabase
                    .from('tokens')
                    .insert([
                        { 
                            symbol: s, 
                            name: n, 
                            coin_id: n.toLowerCase()
                        }
                    ])
                    .select();
                
                if (error) throw error;
                
                console.log('‚úÖ Token adicionado:', data[0]);
                inp.value = '';
                
                // O realtime vai atualizar automaticamente
                
            } catch (error) {
                console.error('‚ùå Erro ao adicionar token:', error);
                alert('Erro ao adicionar token. Verifique console.');
            }
        },

        rem: async (s) => {
            if(!confirm(`Remover ${s}?`)) return;
            
            try {
                // Remover do Supabase
                const { error } = await supabase
                    .from('tokens')
                    .delete()
                    .eq('symbol', s);
                
                if (error) throw error;
                
                console.log('üóëÔ∏è Token removido:', s);
                
                // O realtime vai atualizar automaticamente
                
            } catch (error) {
                console.error('‚ùå Erro ao remover token:', error);
                alert('Erro ao remover token.');
            }
        },

        removeSelected: async () => {
            const selected = Array.from(document.querySelectorAll('#settings-tokens-list input:checked'))
                .map(cb => cb.value);
            
            if(selected.length === 0) return;
            if(!confirm(`Remover ${selected.length} tokens?`)) return;
            
            try {
                // Remover em lote do Supabase
                const { error } = await supabase
                    .from('tokens')
                    .delete()
                    .in('symbol', selected);
                
                if (error) throw error;
                
                console.log('üóëÔ∏è Tokens removidos:', selected);
                App.Settings.closeModal();
                
                // O realtime vai atualizar automaticamente
                
            } catch (error) {
                console.error('‚ùå Erro ao remover tokens:', error);
                alert('Erro ao remover tokens.');
            }
        },

        addBatch: async () => {
            const txt = document.getElementById('batch-tokens');
            const lines = txt?.value.trim().toUpperCase().split('\n').filter(t => t.trim()) || [];
            
            if(lines.length === 0) return;
            
            const tokensToAdd = [];
            
            for(let t of lines) {
                let s = t.trim();
                if(!s.endsWith('USDT')) s += 'USDT';
                
                // Evitar duplicatas
                if(!App.State.tokens.find(e => e.symbol === s)) {
                    tokensToAdd.push({
                        symbol: s,
                        name: s.replace('USDT',''),
                        coin_id: s.replace('USDT','').toLowerCase()
                    });
                }
            }
            
            if(tokensToAdd.length === 0) {
                alert('Todos os tokens j√° existem.');
                return;
            }
            
            try {
                // Inserir em lote no Supabase
                const { data, error } = await supabase
                    .from('tokens')
                    .insert(tokensToAdd)
                    .select();
                
                if (error) throw error;
                
                console.log(`‚úÖ ${tokensToAdd.length} tokens adicionados em lote`);
                txt.value = '';
                App.Settings.closeModal();
                
                // O realtime vai atualizar automaticamente
                
            } catch (error) {
                console.error('‚ùå Erro ao adicionar tokens em lote:', error);
                alert('Erro ao adicionar tokens. Verifique console.');
            }
        }
    },

    // --- SETTINGS ---
    Settings: {
        openModal: () => {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.classList.remove('hidden');
            
            // Popular lista de tokens
            const l = document.getElementById('settings-tokens-list');
            if (l) {
                l.innerHTML = App.State.tokens.map(t => `
                    <label class="inline-flex items-center bg-dark-800 px-2 py-1 rounded text-xs border border-gray-700 mr-2 mb-2">
                        <input type="checkbox" value="${t.symbol}" class="mr-1"> ${t.symbol.replace('USDT','')}
                    </label>
                `).join('');
            }
        },
        closeModal: () => {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.classList.add('hidden');
        }
    },

    Export: {
        openModal: () => {
            const modal = document.getElementById('export-modal');
            if (modal) modal.classList.remove('hidden');
        },
        closeModal: () => {
            const modal = document.getElementById('export-modal');
            if (modal) modal.classList.add('hidden');
        },
        gen: (t) => {
            if(t === 'xlsx') {
                const data = Object.keys(App.State.data)
                    .filter(k => App.State.data[k].analysis)
                    .map(k => {
                        const d = App.State.data[k];
                        return {
                            Symbol: k.replace('USDT', ''),
                            Price: d.analysis.price,
                            Score: d.analysis.score,
                            Risk: d.analysis.risk.class,
                            Asymmetry: d.analysis.asymmetry.toFixed(2),
                            Prob: d.analysis.probProfit.toFixed(0) + '%',
                            'Zona Log': d.analysis.positionInBand.toFixed(0) + '%',
                            'Vol Anual': (d.analysis.volAnn * 100).toFixed(0) + '%',
                            'RSI Weekly': d.analysis.rsiW.toFixed(0)
                        };
                    });
                
                if (data.length === 0) {
                    alert('Nenhum dado para exportar.');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, "Holder Data");
                XLSX.writeFile(wb, "HolderRiskData.xlsx");
            }
            App.Export.closeModal();
        }
    }
};

// Inicializar a aplica√ß√£o quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', () => {
    // Verificar se as bibliotecas est√£o carregadas
    if (typeof LightweightCharts === 'undefined') {
        console.error('LightweightCharts n√£o carregado');
        return;
    }
    if (typeof XLSX === 'undefined') {
        console.error('SheetJS n√£o carregado');
        return;
    }
    
    App.Core.init().catch(error => {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        document.getElementById('last-update').innerText = 'Erro na inicializa√ß√£o';
    });
});
    </script>
</body>
</html>
